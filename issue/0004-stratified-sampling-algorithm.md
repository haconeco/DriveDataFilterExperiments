# Issue 0004: 層化サンプリングの分布分析と確率計算ロジック実装

## 背景
シナリオ軸とクリップメタデータが整備された後、全データセットの分布を可視化し、希少シナリオを強調するサンプリング確率を算出するアルゴリズムが必要です。多次元ヒストグラム分析と重み計算ロジックを実装することで、目標分布に沿ったデータ選択が可能になります。

## タスク詳細
1. **分布分析のためのデータマート整備**
   - Issue 0003で生成したクリップメタデータを読み込み、シナリオ軸ごとに必要な列のクレンジング・正規化（カテゴリID化、ビン番号付与）を実施する。
   - 欠損値や異常値（例: 速度が負、時間帯が未設定）を検知するルールを実装し、フィルタリング結果をログ化する。
2. **多次元ヒストグラム・分布指標の算出**
   - 軸ごとの単変量分布と、2〜3軸を組み合わせたクロス集計を生成する。ヒストグラム粒度はIssue 0002で決定したビン定義を利用する。
   - サマリ指標（平均、分散、希少ビンの割合、ゼロカウントビン数）を算出し、表形式で出力する。
3. **サンプリング確率計算ロジック**
   - 目標分布テーブルと実測分布を突き合わせ、ビンごとのサンプリング重みを計算する関数を実装する。
   - 極端な重みの発生を防ぐため、温度パラメータやクリップ上限/下限を導入し、ハイパーパラメータ一覧と推奨値をドキュメント化する。
   - データ不足ビンに対しては追加収集フラグや補完方法（類似ビンからのバックフィル）を付与する仕組みを設計する。
4. **サンプリング処理のプロトタイプ**
   - 計算した重みを用いて、クリップIDリストから確率的サンプリングを行うサンプルスクリプトを実装する。
   - 乱数シード設定、再現性確保、分割比率（train/val/test）を制御するパラメータを実装する。
5. **可視化と検証**
   - サンプリング前後の分布差分を可視化する（棒グラフ、ヒートマップ）。
   - 希少シナリオの抽出率が目標値に収束しているかを統計的検定（例: カイ二乗検定）で評価し、検証結果をレポート化する。

## 成果物
- 多次元ヒストグラム生成・分布分析スクリプト
- サンプリング確率計算および抽出処理コード、ハイパーパラメータ表
- 分布比較グラフと検定結果を含む可視化レポート

## 追加で確認すべき情報
- 目標分布テーブルの最終合意版（Issue 0002の成果物）
- サンプリング結果が入力となる後段パイプライン（学習/評価）で要求されるフォーマット
- 統計検定の社内標準手順や使用可能な分析ツール
