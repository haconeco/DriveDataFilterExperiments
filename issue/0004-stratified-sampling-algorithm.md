# Issue 0004: 層化サンプリングの分布分析と確率計算ロジック実装

## 背景
シナリオ軸とクリップメタデータが整備された後、全データセットの分布を可視化し、希少シナリオを強調するサンプリング確率を算出するアルゴリズムが必要です。多次元ヒストグラム分析と重み計算ロジックを実装することで、目標分布に沿ったデータ選択が可能になります。

## タスク詳細
1. **分布分析のためのデータマート整備**
   - Issue 0003で生成したクリップメタデータを読み込み、シナリオ軸ごとに必要な列のクレンジング・正規化（カテゴリID化、ビン番号付与）を実施する。
   - 欠損値や異常値（例: 速度が負、時間帯が未設定）を検知するルールを実装し、フィルタリング結果をログ化する。
2. **多次元ヒストグラム・分布指標の算出**
   - 軸ごとの単変量分布と、2〜3軸を組み合わせたクロス集計を生成する。ヒストグラム粒度はIssue 0002で決定したビン定義を利用する。
   - サマリ指標（平均、分散、希少ビンの割合、ゼロカウントビン数）を算出し、表形式で出力する。
3. **サンプリング確率計算ロジック**
   - 目標分布テーブルと実測分布を突き合わせ、ビンごとのサンプリング重みを計算する関数を実装する。
   - 極端な重みの発生を防ぐため、温度パラメータやクリップ上限/下限を導入し、ハイパーパラメータ一覧と推奨値をドキュメント化する。
   - データ不足ビンに対しては追加収集フラグや補完方法（類似ビンからのバックフィル）を付与する仕組みを設計する。
4. **サンプリング処理のプロトタイプ**
   - 計算した重みを用いて、クリップIDリストから確率的サンプリングを行うサンプルスクリプトを実装する。
   - 乱数シード設定、再現性確保、分割比率（train/val/test）を制御するパラメータを実装する。
5. **可視化と検証**
   - サンプリング前後の分布差分を可視化する（棒グラフ、ヒートマップ）。
   - 希少シナリオの抽出率が目標値に収束しているかを統計的検定（例: カイ二乗検定）で評価し、検証結果をレポート化する。

6. **高次元データ圧縮と多様性維持アルゴリズムの選定調査**
   - NuScenesの高次元特徴量（メタデータ軸、CAN-bus統計、センサーレスポンス派生特徴）を対象に、P%（10〜50%）程度の削減で多様性を維持できる一般的な機械学習手法を網羅的にレビューする。
   - 各手法について、長所・短所・本課題（多軸多様性を保ちながらの冗長データ削減）との適正度・計算オーダー（O(n), O(n log n), O(nk)など）を整理した比較表を作成し、実務適用の優先順位でソートする。
   - 既存の社内/OSSライブラリで実装済みのコンポーネントがあるかを確認し、PoC着手時の初期実装候補を決定する。

### 高次元サブサンプリング手法の比較表（優先度順）

| 優先度 | 手法 | Pros | Cons | 本課題での適正度 | 実行コスト（代表例） |
| --- | --- | --- | --- | --- | --- |
| 1 | 層化k-means＋クラスタ代表抽出（メドイド/重み付きリザーバ） | 高速・実装容易、層化軸と連携しやすく希少クラスタに重み付け可能 | 非凸構造や連続的密度勾配を取りこぼす可能性、初期値依存 | 高：NuScenesメタ特徴と整合しやすく微調整容易 | O(nkt)（n:サンプル、k:クラスタ数、t:繰返し） |
| 2 | 施設配置型サブモジュラ最大化（Facility Location + 貪欲） | 多様性最大化保証の近似性能、希少点を自動で残す | 貪欲反復で計算負荷が高い、実装複雑 | 高：多様なシナリオ保持に有効で理論的保証あり | O(nk) ≒ O(n·選択数) |
| 3 | k-center貪欲コアセット（Gonzalez法） | 半径最小化により代表点が均等に散らばる、実装単純 | 外れ値に引っ張られやすく重み制御が必要 | 中〜高：距離定義が確立できれば堅牢 | O(nk) |
| 4 | Determinantal Point Process（k-DPP）サンプリング | 理論的に多様性を定量化、連続空間でも適用可 | カーネル行列構築・固有値分解が重く大規模データに不向き | 中：数万点規模なら可、CAN-bus高次元では前処理必須 | O(n^3)（固有値分解）、近似でO(nk^2) |
| 5 | BADGE等の勾配多様性ベースActive Learning | モデル勾配空間での多様性確保、性能改善と連携 | 学習済みモデルと勾配計算が前提、推論コスト高 | 中：モデル更新と連動する場合に有効 | O(n·d)（d:勾配次元） |
| 6 | オートエンコーダ潜在空間格子サンプリング | 非線形特徴を圧縮し格子サンプルで多様性確保 | 事前学習が必要、過学習で多様性喪失リスク | 中：潜在空間の品質次第で効果がぶれる | O(n·E)（E:エポック数）+格子生成O(g) |
| 7 | 混合整数計画による最適カバレッジ選択 | 厳密最適化で制約（層化比率等）を同時満たせる | 計算爆発、ソルバ依存、実運用で非現実的 | 低：小規模PoCのみ現実的 | O(2^n)〜指数的 |

> 備考: いずれの手法でも、事前に次元削減（PCA/UMAP）や距離指標のスケーリングを検討し、多軸（時間帯×天候など）ごとの層化重みと組み合わせることでNuScenes特有のカバレッジ要件に適合させる。

## 成果物
- 多次元ヒストグラム生成・分布分析スクリプト
- サンプリング確率計算および抽出処理コード、ハイパーパラメータ表
- 分布比較グラフと検定結果を含む可視化レポート
- 高次元サブサンプリング手法の比較表と選定理由メモ

## 追加で確認すべき情報
- 目標分布テーブルの最終合意版（Issue 0002の成果物）
- サンプリング結果が入力となる後段パイプライン（学習/評価）で要求されるフォーマット
- 統計検定の社内標準手順や使用可能な分析ツール
- NuScenes特徴量空間の次元数・疎密度、および削減対象データ総数
