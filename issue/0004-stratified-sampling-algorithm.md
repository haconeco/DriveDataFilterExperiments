# Issue 0004: 層化サンプリングの分布分析・確率計算ロジック詳細化

## 背景
シナリオ軸とクリップメタデータが整備された後、層化サンプリングを機能させるためには、多次元分布の可視化・重み計算・抽出処理を安定して実行できるアルゴリズム群が必要です。本Issueでは分析フローと実装要件を具体化し、テスト観点を明確にします。

## タスク
1. **データ前処理と検証**
   - クリップメタデータのスキーマに基づき、欠損値・型不一致・異常値を検出する前処理モジュールを実装する。
   - ビン境界定義とデータの整合性を検証するユニットテストを用意し、期待外れのカテゴリは警告として集計する。
2. **多次元分布分析の実装**
   - 選択した軸の組み合わせに対して、1〜4次元のヒートマップ／ピボット集計を生成するライブラリ（例：`pandas`, `numpy`, `polars`）を用意する。
   - 軸数が多い場合のために、マージナル分布や条件付き分布の自動生成、希少ビンのランキング出力を追加する。
   - 出力を可視化（ヒートマップ、レーダーチャート、モザイクプロットなど）するテンプレートNotebookを整備する。
3. **サンプリング確率の設計・実装**
   - 目標分布との比較に基づく基本式（例：`p = min(upper, max(lower, (target + alpha)/(observed + beta)))`）を実装し、平滑化パラメータ `alpha`, `beta`、上限`upper`・下限`lower`を設定可能にする。
   - 未観測ビン／データ欠損ビンに対し、バックオフ先（上位階層軸、時間帯のみなど）を選ぶフォールバックロジックを実装する。
   - サンプリングシードや再現性を担保するための乱数管理、重複選択制御（クリップ単位の一意制約）を組み込む。
4. **サンプリング実行パイプラインの構築**
   - 計算した確率に従いデータを抽出するCLIまたは関数を提供し、抽出結果（選択されたクリップID、確率、理由タグ）をログに残す。
   - フルデータ／miniデータの両方で動作可能な設定ファイル（選択軸、サンプリング目標、フィルタ条件）を作成する。
   - 実行結果を検証する自動テスト（目標数に対する誤差率、希少ビンの増幅率など）を追加する。
5. **レポーティングとレビューのための成果物**
   - before/after の分布比較グラフ、希少ビンの採用率、抽出ログサマリーをレポートテンプレートとして整備する。
   - サンプリングポリシーやパラメータを変更した場合の比較結果を格納するリポジトリ構造を定義する。

## 必要な追加情報
- 目標分布の定量値（Issue 0002 の決定結果）と、優先的に強化したい希少ビン定義。
- サンプリング結果の保存先（データベース／ストレージ）とログフォーマットに関する運用要件。
- 使用予定の分析ライブラリや社内標準ツール（例：特定バージョンの`pandas`、BIツール連携）の制約。

## 成果物
- 分布分析・可視化ノートブックおよび集計スクリプト。
- サンプリング確率計算ロジックと抽出パイプラインのコード、テストケース。
- before/after 分布比較レポートと運用用ドキュメント。
