# Issue 0002: 層化サンプリング要件の整理と設計確定

## 背景
nuScenesを例にした層化サンプリング手法を導入するためには、収集データをどの軸で分類し、どのような分布を目標とするかを明確に定義する必要があります。事前にシナリオ軸やビンの設計を固めることで、後続のデータ処理・サンプリング処理が一貫した指標で実装できます。

## タスク詳細
1. **シナリオ軸の候補抽出と優先度付け**
   - nuScenes公式アノテーション仕様のシーン属性（例: 天候、時間帯、場所、分割スプリット）と、自社要件で追加したい要素（例: 路面状態、交通量）を洗い出す。【要参照: docs/high_level_strategy_and_structure.md, https://www.nuscenes.org/nuscenes#data-annotation】
   - `scene`, `log`, `map`, `sample_annotation`, CAN busの各テーブル/ファイルを横断して、取得可能な候補軸（天候、時間帯、マップ領域、道路種別、交通量、車両挙動、センサー稼働状態など）を一覧化する。nuScenes devkitの`nuscenes.scene`、`nuscenes.can_bus` APIを用いて実地で抽出例を作成する。
   - まずはヒューリスティックにnuScenes + CAN busデータ全体を分析し、各軸の現状分布（例: 日中/夜間比率、`can_bus`の速度ヒストグラム、`sample_annotation`内の車種構成）を把握するPythonノートブック/スクリプトを用意する。極端な偏り・欠損の有無をコメント付きで記録する。
   - 軸ごとに「収集容易性」「再現性」「カバレッジへの寄与」「既存データ量」の4指標をスコアリングし、優先度マトリクスを作成する。各スコアの定義、定量化の手順（例: 既存データ量=ヒストグラムのサンプル数）を明文化する。
   - 将来追加を想定した軸（例: 周辺車両の挙動、路面状態、センサーフュージョンクオリティ）について拡張計画を整理し、必要な追加データソースやアノテーションコストを推定する。
   - 一般論として必須と見なす軸（天候、時間帯、地理ロケーション/マップ領域、交通量または周辺アクター密度、車両速度・加速度、道路クラス/レーンタイプ）は、ヒューリスティック分析結果に関わらず初期版の層化セットに含める前提を明記する。
2. **ビン定義と境界条件策定**
   - 各シナリオ軸について、数値系は分位点や専門家知見をもとにビン境界を提案し、カテゴリ系はnuScenes定義（例: weather="rain", time_of_day="night"）をベースに統合・拡張ルールを整理する。
   - ヒューリスティック分析で得た分布を活用し、`0-5`, `5-10`のような時間帯ビンや、速度ビン（例: `0-10`, `10-30`, `30+` km/h）、加速度ビン（例: `-3~-1`, `-1~1`, `1~3` m/s²）、道路クラス（例: `arterial`, `residential`, `highway`）などの候補をデータ駆動で決定する。CAN busの生値がm/sで提供される場合はkm/h換算のロジックも併記する。
   - ビン設定時にデータが存在しない領域・極端に少ない領域を自動検出する処理（例: サンプル数しきい値未満のビンをマージ）を検討し、その統合・再分割ルール（優先統合先、再分割のトリガー）を明文化する。該当領域がnuScenes上で発生する代表シーンIDも合わせて記録する。
   - ビン名称、条件式、使用するデータフィールド、単位系（m/s, km/h, アクター数など）、算出ロジック（例: `traffic_density = count(sample_annotation where category in [vehicle.*]) / road_length`）を整理したテーブルを作成し、更新手順（例: 新バージョンのnuScenesに追随する場合の再集計フロー）を仕様化する。
   - ビンごとの代表値、含めるサンプル条件、例外処理（欠損値、複数ラベル混在時の判定基準）をテーブル化する。
3. **目標分布とデータ需要量の設計**
   - 学習セット全体の目標規模（総クリップ数）を定義し、シナリオ軸の組合せごとに割り当てる目標比率/件数を算出する。
   - 「完全一様」「希少シナリオ強調」など複数パターンの候補目標分布を試算し、利点・欠点・想定リスクを比較する。
4. **サンプリング重みと境界条件の仕様化**
   - 各ビンの実測数と目標数からサンプリング確率を計算する式を確定し、0除算・極小サンプル時の平滑化、上限クリップ（例: \(P=\min(1, \alpha\cdot N_{target}/N_{bin})\)）などの補正ルールを定める。
   - 対象外とするデータ（品質不良、センサー欠損）を抽出するフィルタリング条件も合わせて仕様化する。
   - サンプリングおよびフィルタリングの各段階でデータ多様性を広く保つことを目的に、Determinantal Point Processes（Kulesza & Taskar, 2012）やCore-Setベースサブモジュラー最適化（Sener & Savarese, 2018）などの機械学習手法を調査し、適用可能性・導入コスト・期待効果を整理する。
5. **ドキュメント化と承認プロセス**
   - 上記設計内容を仕様書にまとめ、レビュー観点（MLチーム、データ収集チーム、運用チーム）をリスト化する。
   - レビュー結果を反映し、合意済み版としてドキュメントを確定させる。

## 成果物
- シナリオ軸・ビン定義の仕様書（テーブル形式、補正ルール含む）
- 目標分布とサンプリング重み計算ルールの設計書
- レビュー記録と承認済みドキュメント

## 追加で確認すべき情報
- nuScenesフルデータセット（train/val/test, attribute JSON, mapデータ）へのアクセス権限と利用ルール
- 自社内で優先する運用軸（例: 特定地理エリアや走行モード）に関するビジネス側要望
