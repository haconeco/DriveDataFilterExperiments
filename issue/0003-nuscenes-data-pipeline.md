# Issue 0003: nuScenesデータ処理パイプラインの詳細実装

## 背景
層化サンプリングを成立させるには、nuScenesのセンサーデータ・メタデータ・CAN情報を時間クリップ単位に正規化し、軸ごとの特徴量を抽出する安定したパイプラインが必要です。本Issueでは抽出対象フィールド、同期ロジック、永続化形式まで含めた詳細実装タスクを列挙します。

## タスク
1. **クリップ分割・同期処理の実装**
   - `scene`→`sample`→`sample_data`→`ego_pose` のタイムスタンプを利用し、指定長（例：5秒）でスライディング／固定幅クリップを生成する。
   - クリップ境界に跨るフレームの扱い（除外・重複許可など）と、サンプリング周波数差（センサー種別間）に対する補間ルールを定義する。
   - `can_bus` ログの時刻を `sample` タイムスタンプへ補間し、速度・加速度・操舵角などをクリップ内に整列させる。
2. **静的コンテキスト抽出の強化**
   - `scene.description`, `log.location` から天候・時間帯・ロケーションを正規化（例：`rainy`, `clear`, `night`）。
   - `map_api` を利用し、各 `ego_pose` の位置を道路構造レイヤー（`road_segment`, `intersection`, `lane_connector`, `stop_line` 等）にマッピングし、クリップ内最多レイヤーを代表値として付与する。
   - 地図レイヤー取得が失敗した場合のフォールバック（例：`unknown_map_context`）を定める。
3. **自車挙動特徴量の生成**
   - CAN-bus の `vehicle_monitor.vehicle_speed`, `imu.accel`, `steer.steering`, `vehicle_monitor.yaw_rate` 等から平均・最大・分位点などを計算し、急挙動イベント（閾値超過の有無とタイムスタンプ）を抽出する。
   - CANが欠損したクリップについては欠損フラグを立て、サンプリング重み計算で扱えるようにする。
   - IMUおよびEgo poseから横加速度・曲率半径を導出し、道路曲率タグと連携させる。
4. **動的交通状況の集計**
   - `sample_annotation` からクリップ内のオブジェクトを集計し、カテゴリ別カウント（歩行者、二輪、車両など）と属性比率（`vehicle.moving`, `pedestrian.standing` 等）を算出する。
   - 交通密度や交差点での信号状態を抽出するため、必要に応じて信号機アノテーションやトラッキング情報への拡張可否を検討する。
5. **永続化・検証フローの整備**
   - クリップ単位の特徴量をスキーマ化し、`parquet` または `jsonl` 形式でエクスポートする。スキーマには型、単位、説明を含める。
   - データ品質検証（NULL率、統計範囲チェック、件数一致）を自動化するテストスクリプトを追加し、CIやバッチ実行時に利用できるようにする。
   - miniデータセットで動作確認し、処理時間・リソース要件・期待出力件数をドキュメント化する。

## 必要な追加情報
- CAN-busログのファイル構成（セッションごとの存在可否、キー一覧）とパス。
- `map_api` の利用方法（利用可能なレイヤー名、API呼び出し例、座標系合わせ方）。
- 信号機や交通ルールを表す追加アノテーションをどこまで取得・利用できるか。

## 成果物
- クリップ生成・特徴量抽出スクリプト（モジュール化されたPythonコード一式）。
- クリップメタデータのスキーマ定義書とサンプル出力。
- 実行手順および品質検証レポート（mini/fullの計測結果含む）。
