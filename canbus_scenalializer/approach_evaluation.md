# シナリオ分類判定方式の検討 (Evaluation of Scenario Classification Approaches)

本ドキュメントでは、NuScenesやNuPlanのデータを用いて、定義した「自車挙動シナリオ」を判定するための方式（ルールベース vs 機械学習ベース）を比較・検討し、推奨方針をまとめる。

## 1. データセットの現状 (Data Availability)

### NuScenes
*   **CAN Bus Data**: `pose`, `steer_angle_feedback`, `vehicle_monitor` (車速, 操舵角, ヨーレート, ウインカー等) が利用可能。
*   **Annotations**: 3D Bounding Boxと属性のみ。自車の「挙動（右折中、車線変更中）」を示す直接的なアノテーションは存在しない。Map情報と照らし合わせることで推測は可能（例: 交差点内での移動）。

### NuPlan
*   **Ego Vehicle Data**: 位置、速度、加速度、操舵角などの運動学的データが利用可能。
*   **Annotations**: プランニング用のデータセットであり、**75種類のシナリオタグ**（例: `starting_left_turn`, `changing_lane`, `stopping_with_lead`）が付与されている。これらはイベント発生時点を示すタグであり、連続的な状態（例: ずっと直進中）を保証するものではないが、正解ラベルの候補として非常に有用である。

## 2. 方式比較 (Comparison)

| 項目 | ルールベース (Rule-Based) | 機械学習ベース (ML-Based) |
| :--- | :--- | :--- |
| **判定ロジック** | 閾値判定 (例: 車速 < 0.1 で「停車」) | データからパターンを学習 |
| **開発コスト** | **低**。ロジック実装とパラメータ調整のみ。 | **高**。学習データの作成（アノテーション）、モデル選定、学習、評価が必要。 |
| **説明可能性** | **高**。なぜその判定になったか明確（例: 操舵角が閾値を超えたため）。 | **低**。ブラックボックスになりがち。 |
| **精度・汎化性** | パラメータ調整に依存。複雑な境界（緩やかなカーブ vs 車線変更）で誤判定の可能性。 | データ量が十分であれば、複雑なパターンも認識可能。ノイズに強い。 |
| **開始要件** | 定義とCANデータがあれば即座に開始可能。 | **教師データ（正解ラベル）が必須**。現状、この分類定義に対応するラベルがないため、数千フレームの手動作成が必要。 |

## 3. 推奨方針 (Recommendation)

**結論: ルールベース (Rule-Based) での開始を推奨するが、NuPlanデータを用いる場合はハイブリッド方式も検討可能。**

### 理由
1.  **NuPlanのタグ活用**: NuPlanには `starting_left_turn` や `changing_lane` といった詳細なタグが存在することが判明した。これらは「イベント」としての正解ラベルになり得る。
2.  **連続性の課題**: ただし、我々が定義したいのは「各瞬間の挙動（State）」であり、NuPlanのタグは「シナリオの種類（Type）」や「イベント開始点」であることが多い。したがって、そのまま教師データとして使うには、タグから期間への変換（例: `starting_left_turn` から数秒間を "Left Turn" とする）などの前処理が必要となる。
3.  **ルールベースの堅実性**: まずはルールベースで「状態」を定義し、NuPlanのタグと突き合わせることで、ルールベースの精度検証（Validation）を行うのが最も効率的である。

## 4. 今後のステップ (Next Steps)

1.  **ルールベース判定器の実装**:
    *   NuScenes CAN busデータを読み込み、各フレームを判定するPythonスクリプトを作成する。
    *   閾値（Threshold）の調整用パラメータファイルを用意する。
2.  **可視化による検証**:
    *   判定結果をNuScenesの可視化ツールにオーバーレイし、違和感がないか確認する。
3.  **（必要に応じて）MLへの拡張**:
    *   ルールベースで判定が難しいケース（例: ウインカーを出さずに車線変更、複雑な路地での挙動）が多い場合のみ、ルールベースの結果を修正して教師データとし、MLモデル（時系列分類モデル等）を学習させる。

以上
